# 我的世界网页版游戏 - 开发计划

## 项目概述

基于Three.js的完整可维护的Minecraft网页版游戏，采用TypeScript + Vite + pnpm构建。

## 技术栈

- **语言**: TypeScript
- **构建工具**: Vite
- **包管理器**: pnpm
- **3D引擎**: Three.js
- **代码规范**: ESLint + Prettier

## 项目结构

```
/mnt/f/Projects/Html5/mc/
├── src/
│   ├── main.ts                 # 入口文件
│   ├── core/                   # 核心引擎
│   │   ├── Game.ts             # 游戏主类
│   │   ├── Renderer.ts         # 渲染器
│   │   ├── World.ts            # 世界管理
│   │   └── Camera.ts           # 相机控制
│   ├── world/                  # 世界系统
│   │   ├── Chunk.ts            # 区块类 (16x16x16)
│   │   ├── ChunkManager.ts     # 区块管理器
│   │   ├── BlockType.ts        # 方块类型定义
│   │   ├── Block.ts            # 方块类
│   │   ├── MeshBuilder.ts      # 网格构建器
│   │   └── TerrainGenerator.ts # 地形生成器
│   ├── player/                 # 玩家系统
│   │   ├── Player.ts           # 玩家类
│   │   ├── PlayerController.ts # 玩家控制器
│   │   └── Physics.ts          # 物理引擎 (射线检测)
│   ├── input/                  # 输入系统
│   │   ├── InputHandler.ts     # 输入处理器
│   │   └── KeyBindings.ts      # 按键绑定
│   ├── ui/                     # 用户界面
│   │   └── UIManager.ts        # UI管理器 (准星、物品栏、调试信息)
│   ├── save/                   # 存档系统
│   │   └── SaveManager.ts      # IndexedDB 存档管理器
│   └── utils/                  # 工具类
│       ├── Constants.ts        # 常量定义
│       ├── TextureLoader.ts    # 纹理加载器
│       ├── GeometryCache.ts    # 几何体缓存
│       └── BlockIconRenderer.ts # 方块3D图标渲染器
├── images/                     # 图片资源
│   ├── textures.png            # 方块纹理 (128x48, 16x16每格)
│   └── loading.gif             # 加载动画
├── index.html                  # HTML入口
├── package.json                # 包配置
├── tsconfig.json               # TS配置
├── vite.config.ts              # Vite配置
└── .gitignore
```

## 开发进度

### Phase 1: 基础架构 (已完成)

- [x] 项目初始化 (package.json, vite.config.ts, tsconfig.json)
- [x] Three.js 环境搭建
- [x] 纹理加载器 (解析 textures.png)
- [x] 代码规范配置 (ESLint + Prettier)

### Phase 2: 区块系统与地形 (已完成)

- [x] BlockType 枚举定义 (256种方块支持)
- [x] Chunk 类 (16x16x16 Uint8Array 存储)
- [x] ChunkManager (区块加载/卸载、渲染距离管理)
- [x] TerrainGenerator (地形生成)
- [x] MeshBuilder (面剔除 + 可见面合并)
- [x] 几何体缓存优化

### Phase 3: 玩家与物理 (已完成)

- [x] Player 类 (位置、速度、AABB碰撞)
- [x] 第一人称相机控制 (鼠标锁定)
- [x] WASD 移动控制
- [x] 重力与跳跃
- [x] 碰撞检测 (AABB vs 方块)
- [x] 方块射线检测 (Physics.raycast)

### Phase 4: 交互系统 (已完成)

- [x] 挖掘方块 (左键)
- [x] 放置方块 (右键)
- [x] 方块纹理映射 (UV映射)
- [x] 热键选择 (1-9数字键)

### Phase 5: 物品栏与输入优化 (已完成)

- [x] 鼠标滚轮切换物品 (循环切换)
- [x] 修复区块边缘更新 BUG (跨区块边界检测)
- [x] 物品栏3D方块图标 (实时渲染到Canvas)

### Phase 6: 存档系统 (已完成)

- [x] SaveManager 类 (IndexedDB 封装)
- [x] 区块数据序列化/反序列化
- [x] 玩家位置保存/加载
- [x] 自动保存机制 (5秒延迟保存区块，30秒保存玩家位置)
- [x] 多世界支持 (世界列表、删除世界)

### Phase 7: UI完善 (已完成)

- [x] 暂停菜单 (ESC键、Resume/Return to Main Menu按钮)
- [x] 存档管理界面 (世界列表、新建/加载/删除世界)
- [x] 修复：点击菜单按钮时不应触发方块挖掘
- [x] 修复：返回主菜单后重新进入游戏时的状态管理问题（指针锁定、菜单层级）

### Phase 7.5: Bug修复与优化

- [x] 修复（重点！）：**挖掘穿透bug**
      “例如玩家向前(z-方向)移动直至碰撞时，玩家位置会到达(z=5.3)处，此时进行挖掘可能导致可能射线发射点在**前面的方块**的内部，导致实际挖掘的是**前面的前面的方块**，而不是**前面的方块**”
      “并且有时候玩家也会陷入方块内导致无法移动”
- [x] 调试信息显示优化：例如增加角色朝向信息、鼠标指针指向的物体的坐标等，fps改为一秒内实际渲染的帧数（每秒更新）而不是通过渲染间隔求瞬时帧数，增加手动修改玩家坐标的功能
- [x] 修复：Y>=16高度无法放置方块（当前区块高度限制硬编码限制为16，需区块支持更高建筑）
- [x] 添加：区块卸载机制（超出渲染距离的区块应从内存和场景中移除）
- [x] 修复：旋转问题（进入存档时视角是歪的）
- [x] 修复：第一次进入游戏时鼠标应该时没有锁定的，因此初始状态应该显示ESC菜单，等待玩家点击Resume Game按钮锁定指针后进入游戏状态。
- [x] 修复：`BlockIconRenderer.ts` 生成的物品栏3D图标显示过小
- [x] 修复：树叶等透明纹理物体应改为支持透明的材质纹理
- [x] UI：改为更符合原版MC的UI界面 (主页, 存档管理, 暂停菜单等, 使用 background.png 背景纹理)
- [x] 将常量抽离出来到 `Constants.ts` 而不要在代码中硬编码（如玩家初始坐标等）
- [x] 修复：重新进入游戏时，角色有概率无法移动或跳跃（可能与陷入脚下的方块内有关）
- [x] 修复（重要！）：当前在地面右键放置方块有极大概率导致地面中的**某个方块被替换**，而非在地面上放置方块，可能与射线检测有关，可能是射线检测到了方块的侧面而非上表面（会发生该问题时调试信息显示face: 4或face: 5；并且仅当Yaw为0°或180°方向时则能正常放置方块，显示是正常的face: 0）？（但注意目前已经解决了**挖掘穿透bug**，修改射线检测时注意**不要让挖掘穿透bug复发**）

### Phase 8: 游戏内容扩展 (已完成)

- [x] 基于 Simplex Noise 生成地形、树、群系等
- [x] 树的生成位置也改为使用 Simplex Noise 随机而非固定间隔
- [x] 加载界面优化 (使用 loading.gif + background.png + 进度条作为加载页面，区块完全**加载完成后再显示游戏界面**)
- [x] 增加功能：飞行（双击空格切换）与疾跑（双击W）功能
- [x] 优化：支持区块数据缓存，即区块由近到远分为：渲染区块（<=渲染距离）、缓存区块（<=缓存距离）、非缓存区块
      渲染区块在游戏中实际可见
      缓存区块将区块中方块类型数据缓存在内存中但不渲染（以免加载区块时重新计算导致卡顿，而离开缓存距离时回收内存）
      而非缓存区块随玩家移动到缓存距离内时在后台加载（考虑异步或多线程等不卡顿游戏的方式）
      并且在 Constants.ts 中添加缓存距离和渲染距离常量

### Phase 9: 渲染优化与性能提升 (已完成)

#### 9.1 自定义雾Shader系统（原版Minecraft风格雾效）✅ 已完成

- [x] **目标**: 实现原版Minecraft风格的分层雾效
  - 近处（0-60%渲染距离）：清晰无雾
  - 中距离（60-90%）：逐渐过渡到雾色
  - 远处（90-100%）：完全雾色
  - 边界外：天空色（未加载区域）
- [x] **技术方案**:
  - 创建 `ChunkShaderMaterial.ts` 管理自定义Shader
  - Vertex Shader: 计算世界空间距离，传递给fragment shader
  - Fragment Shader: 基于距离混合纹理颜色与雾色
  - Uniforms: fogColor, fogNear, fogFar, chunkOpacity
- [x] **区块加载淡入**: 新加载区块从雾色逐渐浮现
  - 添加 `chunkOpacity` uniform控制透明度
  - 过渡动画：0→1 约12-13帧（~200ms at 60fps）
- [x] **兼容性**: 支持透明方块（树叶、仙人掌）
- **实现文件**: `src/utils/ChunkShaderMaterial.ts`, `src/world/MeshBuilder.ts`, `src/core/World.ts`

#### 9.2 Worker地形生成（多线程）

- [x] **目标**: 将地形生成移至Web Worker，消除主线程卡顿
- [x] **技术方案**:
  - 创建 `terrain.worker.ts` Web Worker
  - 使用 `SimplexNoise` 库在Worker中生成地形
  - 主线程与Worker通信协议设计
  - 消息类型: `GENERATE_CHUNK`, `CHUNK_READY`, `ERROR`
- [x] **加载队列优化**:
  - 按距离玩家远近排序加载优先级
  - 视线方向（玩家面向）区块优先
  - 分帧处理，避免单帧生成过多区块
- [x] **Fallback机制**: Worker加载失败时回退到主线程生成

### Phase 10: 更多游戏内容扩展

#### 10.1 修复bug

- [x] 修复地形生成时，树生成在区块边缘时树叶无法跨区块生成的问题
- [x] 重新修改树的生成算法，当前树基本上都是几棵几棵集中在一起的（可能是直接让噪声值<=某个值时生成树导致的），实际树应该是一棵一棵散状分布的
- [x] 区块渲染距离在区块加载和区块卸载时留出一部分缓冲（例如可以区块在渲染距离K内时渲染，而在超出K+2距离后再卸载），以避免玩家在区块边缘频繁移动时导致区块频繁加载卸载导致的卡顿
- [x] 修复初次进入游戏中，选项中保存的值不会应用到游戏，而要手动修改一次之后才会应用的问题
- [x] 修复选项中 “鼠标灵敏度” 不生效的问题
- [x] 修复存档列表中莫名出现的 "default" 存档，以及“修改”按钮功能不生效的功能

#### 10.2 复杂地形生成系统（沙漠、山峰、谷地、洞穴）

**目标**: 基于多层噪声的群系系统，实现多样化的地形特征，保证区块边缘连续性

**实现架构**:

```
WorkerTerrainGenerator (地形生成器)
├── 1. 群系生成层 (Biome Generation)
│   - 使用低频噪声 (scale=0.002) 生成群系类型
│   - 群系：平原、沙漠、山地、丘陵
│   - 群系参数 (基础高度范围, 高度变化率)
│
├── 2. 高度生成层 (Height Generation with 群系插值)
│   - 基础高度：查询周围群系，加权插值计算
│     · 权重 = 1 / (distanceToBiomeCenter + epsilon)
│     · 最终高度 = Σ(群系基础高度 × 权重) / Σ(权重)
│   - 细节高度：中频噪声 (0.01) 添加局部起伏 (群系无关，保证连续)
│   - 粗糙度：高频噪声 (0.1) 添加地表细节 (群系无关)
│
├── 3. 洞穴生成层 (Cave Generation)
│   - 3D Simplex Noise (scale=0.03) 减法挖空
│   - 只在 y < 50 （或根据群系调整）的地底生成
│   - 洞穴入口概率连通地表
│
└── 4. 地表装饰层 (Surface Decoration)
    - 根据群系选择地表方块 (使用主导群系，即权重最大的)
    - 平原/丘陵：草→泥土→石头
    - 沙漠：沙子→沙石→石头
    - 山地：石头直接暴露，顶部有雪 (y>100)
```

**实现步骤**:

- [ ] **Phase 10.2.1**: 群系噪声系统
  - 在 Worker 中添加低频群系噪声 (scale=0.002)
  - 实现群系类型枚举 (PLAINS, DESERT, MOUNTAINS, HILLS)
  - 实现群系参数配置 (baseHeight, variation)

- [ ] **Phase 10.2.2**: 群系边界平滑
  - 查询周围群系
  - 实现 inverse distance weighting 权重计算
  - 基础高度加权插值 (保证区块边缘连续)
  - 细节噪声与群系解耦 (全局一致)

- [ ] **Phase 10.2.3**: 多层次地形细节（分形噪声）
  - 中频噪声 (0.01) 添加局部起伏
  - 高频噪声 (0.05) 添加地表粗糙度
  - 山地群系使用 pow(height, 1.3) 实现陡峭

- [ ] **Phase 10.2.4**: 洞穴系统
  - 添加 3D 洞穴噪声 (Simplex 3D, scale=0.03)
  - 使用噪声减法：if caveNoise > 0.6 → 挖空
  - 洞穴只在 y < 50 （或根据群系调整） 生成，概率性入口连通地表

- [ ] **Phase 10.2.5**: 群系特定方块
  - 添加沙石、雪方块到 BlockType 和纹理图集
  - 根据主导群系 (权重最大) 选择地表方块
  - 山地顶部生成雪 (y > 200)

**性能考虑**:

- 所有噪声计算在 Worker 中进行，不阻塞主线程
- 确定性噪声保证相同位置结果一致
- 群系插值虽然增加了计算量，但只在地形生成时执行，不影响运行时性能

---

#### 10.3 天空系统（太阳、月亮、云）

**目标**: 基于现实时间的动态天空球 + 方形像素风格太阳/月亮 + 方块风格云

**实现架构**:

```
SkySystem (天空系统)
├── 时间系统 (Day = 20分钟 = 1200秒)
│   - currentTime: 0-1200 秒 (现实时间)
│   - 0=日出, 300=正午, 600=日落, 900=午夜, 1200=次日日出
├── 天空渲染 (SkyDome)
│   - 半球形天空穹顶 (SphereGeometry, phiLength=PI)
│   - 根据时间插值天空颜色
├── 天体渲染 (CelestialBodies) - 方形像素精灵!
│   - 太阳：黄色方形像素纹理 (16x16或32x32像素风格)
│   - 月亮：白色方形像素纹理，带月牙/满月相位
│   - 星星：夜晚显示的方形像素点阵 (Points)
└── 云系统 (Clouds)
    - 3D 云层平面在 y=128
    - 方块风格：每个云由多个 4×4x4 半透明方块组成 (InstancedMesh)
    - Simplex Noise 生成云形状，随时间缓慢移动
    - 云下方有阴影（降低光照值）
```

**时间线配置 (现实秒)**:

```
时间(秒)   现实时间   天空颜色           太阳/月亮
────────────────────────────────────────────────────
0-100      ~1.7min   夜晚(深蓝)          月亮高挂
100-200    ~3.3min   日出过渡(紫→橙)     太阳升起
200-500    ~8.3min   白天(天蓝)          太阳高挂
500-600    ~10min    日落过渡(蓝→紫)     太阳落下
600-700    ~11.7min  日落过渡(紫→红)
700-1100   ~18.3min  夜晚(深蓝)          月亮高挂
1100-1200  ~20min    日出过渡(黑→紫)     准备日出
```

**方形像素精灵实现**: 程序化生成，无需图片文件

**实现步骤**:

- [ ] **Phase 10.3.1**: 时间系统
  - 在 Game 类中添加时间循环 (现实秒，0-1200)
  - 20分钟 = 1200秒一个完整昼夜循环
  - 保存/加载世界时持久化时间到 metadata
  - **同步玩家状态**: 同时持久化飞行状态、疾跑状态

- [ ] **Phase 10.3.2**: 天空穹顶
  - 创建半球形天空 Mesh (SphereGeometry, phiLength=Math.PI)
  - 根据时间插值天空颜色 (sunrise→day→sunset→night)
  - 使用自定义 ShaderMaterial 实现渐变

- [ ] **Phase 10.3.3**: 方形像素太阳和月亮
  - 程序化生成方形像素纹理 (CanvasTexture + NearestFilter)
  - 太阳：黄色方形，6:00升起，18:00落下
  - 月亮：白色方形，带简单相位变化 (满月/新月)
  - 星星：夜晚显示 (Points 粒子系统，方形像素点)

- [ ] **Phase 10.3.4**: 方块风格云
  - 在 y=128 高度生成云层
  - 使用 InstancedMesh 渲染方块云
  - 2D Simplex Noise 生成云团形状
  - 云随时间缓慢移动 (每秒移动0.01格)

---

#### 10.4 光照系统

- [ ] 基于方块的光照传播算法，正确实现天空光(15)和方块光源(火把14)

核心规则:
1. 天空光：只要世界顶部(y=255)向下直到非透明方块，保持亮度=15
2. 水平传播：从刚才亮度15的地方向四周寻找未设置亮度的空气方块（例如屋檐下），设置为亮度14的光源（与火把亮度相同）
3. 执行 BFS 算法，计算每个方块距离光源的距离，用最近光源亮度(14) - 距离得到亮度值
4. 由于最大光照强度为15，故 BFS 只需要考虑当前区块和周围区块的光源

**实现架构**:

```
LightingSystem (光照系统)
├── 光照值存储 (Chunk扩展)
│   - blockLight: Uint8Array (0-15)，方块光源
│   - 注意: 每个chunk需要访问邻居chunk进行跨区块传播
├── 渲染集成 (Shader)
│   - ChunkShaderMaterial 添加光照 uniforms
│   - 顶点着色器传入光照值 (每个顶点光照不同，平滑过渡)
│   - 片段着色器: final = max(sky * dayBrightness, block)
└── 动态更新
    - 放置/破坏方块: 局部重计算受影响区域
    - 时间变化: 调整白天亮度系数
```

---

#### 10.5 实体/实体方块系统（沙子坠落）

**目标**: 特定方块在下方无支撑时变为实体方块，受重力下落，停止后又变回方块

**实现架构**:

```
EntitySystem (实体系统)
├── 实体方块定义
│   - 沙子、砾石属于 FALLING_BLOCK_TYPES
│   - 放置/更新时检查下方支撑
│   - 无支撑时转换为 FallingBlock 实体
├── FallingBlock 物理实体
│   - 使用 Mesh 表示下落的方块
│   - 受重力影响 (gravity)
│   - 碰撞检测：与下方方块或地面碰撞
│   - 落地后转换回静态方块
└── 连锁更新 (Chain Updates)
    - 使用队列处理连锁坠落
    - 限制每帧最大处理数 (MAX_FALLING_PER_FRAME=16)
```

**实现步骤**:

- [ ] **Phase 10.5.1**: 实体框架
  - 创建 FallingBlock 实体类
  - 创建 EntityManager 管理所有实体
  - 在 Game.update() 中集成实体更新

- [ ] **Phase 10.5.2**: 沙子坠落逻辑
  - 标记沙子为可坠落方块
  - 放置沙子时或在沙子相邻方块进行挖掘或放置时进行更新
  - 下方为空气时触发坠落

- [ ] **Phase 10.5.3**: 物理下落
  - 实现恒定速度下落
  - 碰撞检测与落地转换

- [ ] **Phase 10.5.4**: 连锁更新
  - 实现稳定性检查队列
  - 一个方块落下后递归检查上方
  - 限制每帧处理数量防止卡顿

---

#### 10.6 玩家状态持久化补充

**现状**: 目前仅保存玩家位置和旋转，缺少飞行状态、疾跑状态、世界时间

**需要持久化的状态**:

```typescript
// 扩展 WorldMetadata 接口
interface WorldMetadata {
  name: string;
  createdAt: number;
  lastPlayed: number;
  playerPosition: { x: number; y: number; z: number };
  playerRotation: { x: number; y: number };
  // 新增字段
  playerState: {
    isFlying: boolean; // 飞行模式
    isSprinting: boolean; // 疾跑模式
  };
  worldTime: number; // 世界时间 (0-1200秒)
}
```

**实现步骤**:

- [ ] **Phase 10.6.1**: 扩展 metadata 结构
  - 在 SaveManager.ts 中扩展 WorldMetadata 接口
  - 更新 savePlayerPosition 方法为 savePlayerState (包含位置、旋转、状态)

- [ ] **Phase 10.6.2**: 玩家状态保存
  - 在 Game.dispose() 和自动保存 (30秒间隔) 时保存状态
  - 保存: isFlying, isSprinting

- [ ] **Phase 10.6.3**: 玩家状态加载
  - 在 Game.initialize() 时加载 playerState
  - 应用到 Player 对象: player.setFlying(state.isFlying)

- [ ] **Phase 10.6.4**: 世界时间持久化
  - 在天空系统实现后，每30秒保存 worldTime
  - 加载世界时恢复时间 (worldSystem.setTime(metadata.worldTime))

## 关键技术决策

### 1. 区块存储

- 使用 Uint8Array 存储方块ID (256种方块)
- 每个 Chunk 16x16x16 = 4096 字节
- 视锥内区块动态加载
- IndexedDB 持久化存储 (键: `worldName:cx,cz`)

#### 区块管理核心概念

**状态定义：**

- **渲染 (Render)**: 区块在场景中可见，有mesh
- **卸载**: 从场景中移除（不再可见），但数据可能保留在内存中
- **缓存 (Cache)**: 区块数据加载到内存（Uint8Array），但不一定可见
- **释放内存**: 删除内存中的区块数据

**距离层级：**

- **Render Distance**: 应该渲染（可见）的区块距离
- **Cache Distance**: 应该缓存（数据在内存）的区块距离
- **Render Buffer**: 用于卸载判断的缓冲距离，和Cache无关

**操作逻辑：**

1. 开始渲染：在 Render Distance 内但当前未渲染的区块
2. 停止渲染（卸载）：当前渲染中但超出 Render Distance + Render Buffer 的区块
3. 开始缓存（加载数据）：在 Cache Distance 内但当前未缓存的区块
4. 释放内存：当前已缓存但超出 Cache Distance 的区块

### 2. 渲染优化

- 只生成朝向空气方块的可见面
- 相同纹理的面合并为单个几何体
- 每个区块一个 InstancedMesh

### 3. 物理系统

- AABB (轴对齐边界框) 碰撞检测
- 简单重力加速度
- 地面碰撞检测

### 4. 方块纹理映射

- textures.png 规格: 128x48, 3行8列
- 每个纹理 16x16 像素
- BlockType 定义每个面的纹理索引

### 5. 存档系统 (IndexedDB)

- 数据库: `MinecraftWebDB`
- 对象存储: `chunks` (区块数据), `metadata` (世界元数据)
- 区块键格式: `${worldName}:${cx},${cz}`
- 自动保存策略:
  - 区块修改后延迟5秒保存
  - 玩家位置每30秒保存
  - 游戏关闭时立即保存所有数据

### 纹理索引映射

```
第一行 (0-7):
0: 命令方块顶面
1: 命令方块侧面
2: 命令方块底面
3: 草方块顶面
4: 草方块侧面
5: 泥土 (草方块底面)
6: 原石
7: 石头

第二行 (8-15):
8: 沙子
9: 木头顶面
10: 木头侧面
11: 树叶 (透明)
12: 木板
13: 砖块
14: 仙人掌顶面 (透明)
15: 仙人掌侧面

第三行 (16-23):
16: 仙人掌底面 (透明)
17-23: 未使用
```

## 性能目标

- 帧率: 60 FPS
- 渲染距离: 8 区块 (128 方块)
- 内存占用: < 500MB
