# 我的世界网页版游戏 - 开发计划

## 项目概述

基于Three.js的完整可维护的Minecraft网页版游戏，采用TypeScript + Vite + pnpm构建。

## 技术栈

- **语言**: TypeScript
- **构建工具**: Vite
- **包管理器**: pnpm
- **3D引擎**: Three.js
- **代码规范**: ESLint + Prettier

## 项目结构

```
/mnt/f/Projects/Html5/mc/
├── src/
│   ├── main.ts                 # 入口文件
│   ├── core/                   # 核心引擎
│   │   ├── Game.ts             # 游戏主类
│   │   ├── Renderer.ts         # 渲染器
│   │   ├── World.ts            # 世界管理
│   │   └── Camera.ts           # 相机控制
│   ├── world/                  # 世界系统
│   │   ├── Chunk.ts            # 区块类 (16x16x16)
│   │   ├── ChunkManager.ts     # 区块管理器
│   │   ├── BlockType.ts        # 方块类型定义
│   │   ├── Block.ts            # 方块类
│   │   ├── MeshBuilder.ts      # 网格构建器
│   │   └── TerrainGenerator.ts # 地形生成器
│   ├── player/                 # 玩家系统
│   │   ├── Player.ts           # 玩家类
│   │   ├── PlayerController.ts # 玩家控制器
│   │   └── Physics.ts          # 物理引擎 (射线检测)
│   ├── input/                  # 输入系统
│   │   ├── InputHandler.ts     # 输入处理器
│   │   └── KeyBindings.ts      # 按键绑定
│   ├── ui/                     # 用户界面
│   │   └── UIManager.ts        # UI管理器 (准星、物品栏、调试信息)
│   ├── save/                   # 存档系统
│   │   └── SaveManager.ts      # IndexedDB 存档管理器
│   └── utils/                  # 工具类
│       ├── Constants.ts        # 常量定义
│       ├── TextureLoader.ts    # 纹理加载器
│       ├── GeometryCache.ts    # 几何体缓存
│       └── BlockIconRenderer.ts # 方块3D图标渲染器
├── images/                     # 图片资源
│   ├── textures.png            # 方块纹理 (128x48, 16x16每格)
│   └── loading.gif             # 加载动画
├── index.html                  # HTML入口
├── package.json                # 包配置
├── tsconfig.json               # TS配置
├── vite.config.ts              # Vite配置
└── .gitignore
```

## 开发进度

### Phase 1: 基础架构 (已完成)

- [x] 项目初始化 (package.json, vite.config.ts, tsconfig.json)
- [x] Three.js 环境搭建
- [x] 纹理加载器 (解析 textures.png)
- [x] 代码规范配置 (ESLint + Prettier)

### Phase 2: 区块系统与地形 (已完成)

- [x] BlockType 枚举定义 (256种方块支持)
- [x] Chunk 类 (16x16x16 Uint8Array 存储)
- [x] ChunkManager (区块加载/卸载、渲染距离管理)
- [x] TerrainGenerator (地形生成)
- [x] MeshBuilder (面剔除 + 可见面合并)
- [x] 几何体缓存优化

### Phase 3: 玩家与物理 (已完成)

- [x] Player 类 (位置、速度、AABB碰撞)
- [x] 第一人称相机控制 (鼠标锁定)
- [x] WASD 移动控制
- [x] 重力与跳跃
- [x] 碰撞检测 (AABB vs 方块)
- [x] 方块射线检测 (Physics.raycast)

### Phase 4: 交互系统 (已完成)

- [x] 挖掘方块 (左键)
- [x] 放置方块 (右键)
- [x] 方块纹理映射 (UV映射)
- [x] 热键选择 (1-9数字键)

### Phase 5: 物品栏与输入优化 (已完成)

- [x] 鼠标滚轮切换物品 (循环切换)
- [x] 修复区块边缘更新 BUG (跨区块边界检测)
- [x] 物品栏3D方块图标 (实时渲染到Canvas)

### Phase 6: 存档系统 (已完成)

- [x] SaveManager 类 (IndexedDB 封装)
- [x] 区块数据序列化/反序列化
- [x] 玩家位置保存/加载
- [x] 自动保存机制 (5秒延迟保存区块，30秒保存玩家位置)
- [x] 多世界支持 (世界列表、删除世界)

### Phase 7: UI完善 (已完成)

- [x] 暂停菜单 (ESC键、Resume/Return to Main Menu按钮)
- [x] 存档管理界面 (世界列表、新建/加载/删除世界)
- [x] 修复：点击菜单按钮时不应触发方块挖掘
- [x] 修复：返回主菜单后重新进入游戏时的状态管理问题（指针锁定、菜单层级）

### Phase 7.5: Bug修复与优化

- [x] 修复（重点！）：**挖掘穿透bug**
      “例如玩家向前(z-方向)移动直至碰撞时，玩家位置会到达(z=5.3)处，此时进行挖掘可能导致可能射线发射点在**前面的方块**的内部，导致实际挖掘的是**前面的前面的方块**，而不是**前面的方块**”
      “并且有时候玩家也会陷入方块内导致无法移动”
- [x] 调试信息显示优化：例如增加角色朝向信息、鼠标指针指向的物体的坐标等，fps改为一秒内实际渲染的帧数（每秒更新）而不是通过渲染间隔求瞬时帧数，增加手动修改玩家坐标的功能
- [x] 修复：Y>=16高度无法放置方块（当前区块高度限制硬编码限制为16，需区块支持更高建筑）
- [x] 添加：区块卸载机制（超出渲染距离的区块应从内存和场景中移除）
- [x] 修复：旋转问题（进入存档时视角是歪的）
- [x] 修复：第一次进入游戏时鼠标应该时没有锁定的，因此初始状态应该显示ESC菜单，等待玩家点击Resume Game按钮锁定指针后进入游戏状态。
- [x] 修复：`BlockIconRenderer.ts` 生成的物品栏3D图标显示过小
- [x] 修复：树叶等透明纹理物体应改为支持透明的材质纹理
- [x] UI：改为更符合原版MC的UI界面 (主页, 存档管理, 暂停菜单等, 使用 background.png 背景纹理)
- [x] 将常量抽离出来到 `Constants.ts` 而不要在代码中硬编码（如玩家初始坐标等）
- [x] 修复：重新进入游戏时，角色有概率无法移动或跳跃（可能与陷入脚下的方块内有关）
- [x] 修复（重要！）：当前在地面右键放置方块有极大概率导致地面中的**某个方块被替换**，而非在地面上放置方块，可能与射线检测有关，可能是射线检测到了方块的侧面而非上表面（会发生该问题时调试信息显示face: 4或face: 5；并且仅当Yaw为0°或180°方向时则能正常放置方块，显示是正常的face: 0）？（但注意目前已经解决了**挖掘穿透bug**，修改射线检测时注意**不要让挖掘穿透bug复发**）

### Phase 8: 游戏内容扩展 (已完成)

- [x] 基于 Simplex Noise 生成地形、树、群系等
- [x] 树的生成位置也改为使用 Simplex Noise 随机而非固定间隔
- [x] 加载界面优化 (使用 loading.gif + background.png + 进度条作为加载页面，区块完全**加载完成后再显示游戏界面**)
- [x] 增加功能：飞行（双击空格切换）与疾跑（双击W）功能
- [x] 优化：支持区块数据缓存，即区块由近到远分为：渲染区块（<=渲染距离）、缓存区块（<=缓存距离）、非缓存区块
      渲染区块在游戏中实际可见
      缓存区块将区块中方块类型数据缓存在内存中但不渲染（以免加载区块时重新计算导致卡顿，而离开缓存距离时回收内存）
      而非缓存区块随玩家移动到缓存距离内时在后台加载（考虑异步或多线程等不卡顿游戏的方式）
      并且在 Constants.ts 中添加缓存距离和渲染距离常量

### Phase 9: 渲染优化与性能提升 (已完成)

#### 9.1 自定义雾Shader系统（原版Minecraft风格雾效）✅ 已完成

- [x] **目标**: 实现原版Minecraft风格的分层雾效
  - 近处（0-60%渲染距离）：清晰无雾
  - 中距离（60-90%）：逐渐过渡到雾色
  - 远处（90-100%）：完全雾色
  - 边界外：天空色（未加载区域）
- [x] **技术方案**:
  - 创建 `ChunkShaderMaterial.ts` 管理自定义Shader
  - Vertex Shader: 计算世界空间距离，传递给fragment shader
  - Fragment Shader: 基于距离混合纹理颜色与雾色
  - Uniforms: fogColor, fogNear, fogFar, chunkOpacity
- [x] **区块加载淡入**: 新加载区块从雾色逐渐浮现
  - 添加 `chunkOpacity` uniform控制透明度
  - 过渡动画：0→1 约12-13帧（~200ms at 60fps）
- [x] **兼容性**: 支持透明方块（树叶、仙人掌）
- **实现文件**: `src/utils/ChunkShaderMaterial.ts`, `src/world/MeshBuilder.ts`, `src/core/World.ts`

#### 9.2 Worker地形生成（多线程）

- [x] **目标**: 将地形生成移至Web Worker，消除主线程卡顿
- [x] **技术方案**:
  - 创建 `terrain.worker.ts` Web Worker
  - 使用 `SimplexNoise` 库在Worker中生成地形
  - 主线程与Worker通信协议设计
  - 消息类型: `GENERATE_CHUNK`, `CHUNK_READY`, `ERROR`
- [x] **加载队列优化**:
  - 按距离玩家远近排序加载优先级
  - 视线方向（玩家面向）区块优先
  - 分帧处理，避免单帧生成过多区块
- [x] **Fallback机制**: Worker加载失败时回退到主线程生成

### Phase 10: 更多游戏内容扩展

#### 10.1 修复bug

- [x] 修复地形生成时，树生成在区块边缘时树叶无法跨区块生成的问题
- [x] 重新修改树的生成算法，当前树基本上都是几棵几棵集中在一起的（可能是直接让噪声值<=某个值时生成树导致的），实际树应该是一棵一棵散状分布的
- [x] 区块渲染距离在区块加载和区块卸载时留出一部分缓冲（例如可以区块在渲染距离K内时渲染，而在超出K+2距离后再卸载），以避免玩家在区块边缘频繁移动时导致区块频繁加载卸载导致的卡顿
- [x] 修复初次进入游戏中，选项中保存的值不会应用到游戏，而要手动修改一次之后才会应用的问题
- [x] 修复选项中 “鼠标灵敏度” 不生效的问题
- [x] 修复存档列表中莫名出现的 "default" 存档，以及“修改”按钮功能不生效的功能

#### 10.2 其它

- [ ] 改造地形生成增加更多复杂地形：如洞穴等（可能）
- [ ] 基于时间的太阳、月亮、云（符合MC风格方块形状）等天空系统
- [ ] 光照系统（每个位置都有计算出的对应的光照值，例如白天与天空直接相连的位置亮度为15，火把亮度14，其它位置每相距一个减少1亮度值直到0，并根据亮度值影响方块材质显示效果）
- [ ] 实体系统．如沙子坠落等

## 关键技术决策

### 1. 区块存储

- 使用 Uint8Array 存储方块ID (256种方块)
- 每个 Chunk 16x16x16 = 4096 字节
- 视锥内区块动态加载
- IndexedDB 持久化存储 (键: `worldName:cx,cz`)

#### 区块管理核心概念

**状态定义：**

- **渲染 (Render)**: 区块在场景中可见，有mesh
- **卸载**: 从场景中移除（不再可见），但数据可能保留在内存中
- **缓存 (Cache)**: 区块数据加载到内存（Uint8Array），但不一定可见
- **释放内存**: 删除内存中的区块数据

**距离层级：**

- **Render Distance**: 应该渲染（可见）的区块距离
- **Cache Distance**: 应该缓存（数据在内存）的区块距离
- **Render Buffer**: 用于卸载判断的缓冲距离，和Cache无关

**操作逻辑：**

1. 开始渲染：在 Render Distance 内但当前未渲染的区块
2. 停止渲染（卸载）：当前渲染中但超出 Render Distance + Render Buffer 的区块
3. 开始缓存（加载数据）：在 Cache Distance 内但当前未缓存的区块
4. 释放内存：当前已缓存但超出 Cache Distance 的区块

### 2. 渲染优化

- 只生成朝向空气方块的可见面
- 相同纹理的面合并为单个几何体
- 每个区块一个 InstancedMesh

### 3. 物理系统

- AABB (轴对齐边界框) 碰撞检测
- 简单重力加速度
- 地面碰撞检测

### 4. 方块纹理映射

- textures.png 规格: 128x48, 3行8列
- 每个纹理 16x16 像素
- BlockType 定义每个面的纹理索引

### 5. 存档系统 (IndexedDB)

- 数据库: `MinecraftWebDB`
- 对象存储: `chunks` (区块数据), `metadata` (世界元数据)
- 区块键格式: `${worldName}:${cx},${cz}`
- 自动保存策略:
  - 区块修改后延迟5秒保存
  - 玩家位置每30秒保存
  - 游戏关闭时立即保存所有数据

### 纹理索引映射

```
第一行 (0-7):
0: 命令方块顶面
1: 命令方块侧面
2: 命令方块底面
3: 草方块顶面
4: 草方块侧面
5: 泥土 (草方块底面)
6: 原石
7: 石头

第二行 (8-15):
8: 沙子
9: 木头顶面
10: 木头侧面
11: 树叶 (透明)
12: 木板
13: 砖块
14: 仙人掌顶面 (透明)
15: 仙人掌侧面

第三行 (16-23):
16: 仙人掌底面 (透明)
17-23: 未使用
```

## 性能目标

- 帧率: 60 FPS
- 渲染距离: 8 区块 (128 方块)
- 内存占用: < 500MB
